{% extends "base.html" %}

{% block title %}Distribution - SmartMeetingAI{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Distribution</h1>
            <p class="text-gray-600">Send meeting invitations via Gmail and WhatsApp</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Template Selection -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-medium text-gray-900">Select Template</h3>
            </div>
            <div class="card-body">
                {% if templates %}
                    <div class="space-y-3">
                        {% for template in templates %}
                        <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer template-item" data-template-id="{{ template.id }}">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium text-gray-900">{{ template.title }}</h4>
                                    <p class="text-sm text-gray-500">
                                        {{ template.meeting_date.strftime('%B %d, %Y') }} at {{ template.meeting_time.strftime('%I:%M %p') }}
                                    </p>
                                    <p class="text-sm text-gray-500">Speaker: {{ template.speaker_name }}</p>
                                </div>
                                <div class="text-right">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {{ template.meeting_type or 'Meeting' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-lg font-medium">No templates available</p>
                        <p class="text-sm">Create a template first to send invitations</p>
                        <a href="{{ url_for('template_generator') }}" class="btn btn-primary mt-4 inline-block">
                            Create Template
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Distribution Methods -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-medium text-gray-900">Send Invitation</h3>
            </div>
            <div class="card-body">
                <div id="no-template-selected" class="text-center py-8 text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    <p class="text-lg font-medium">No template selected</p>
                    <p class="text-sm">Select a template from the left to send invitations</p>
                </div>

                <div id="distribution-form" class="hidden space-y-6">
                    <!-- Selected Template Info -->
                    <div id="selected-template-info" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-medium text-blue-900" id="selected-template-title"></h4>
                        <p class="text-sm text-blue-700" id="selected-template-details"></p>
                    </div>

                    <!-- Distribution Tabs -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button id="gmail-tab" class="distribution-tab border-blue-500 text-blue-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                Gmail
                            </button>
                            <button id="whatsapp-tab" class="distribution-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                WhatsApp
                            </button>
                        </nav>
                    </div>

                    <!-- Gmail Form -->
                    <div id="gmail-form" class="distribution-form">
                        <div>
                            <label for="gmail-recipients" class="form-label">Recipient Emails</label>
                            <textarea id="gmail-recipients" class="form-input" rows="3" placeholder="recipient1@example.com&#10;recipient2@example.com&#10;recipient3@example.com"></textarea>
                            <p class="text-sm text-gray-500 mt-1">Enter one email per line for multiple recipients</p>
                        </div>
                        <div>
                            <label for="gmail-subject" class="form-label">Subject Line</label>
                            <input type="text" id="gmail-subject" class="form-input" placeholder="Meeting Invitation">
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="send-gmail-btn" class="flex-1 btn btn-primary">
                                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                                Send via Gmail
                            </button>
                            <button id="preview-gmail-btn" class="btn btn-secondary">
                                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                Preview
                            </button>
                        </div>
                    </div>

                    <!-- WhatsApp Form -->
                    <div id="whatsapp-form" class="distribution-form hidden">
                        <div>
                            <label for="whatsapp-phone" class="form-label">Phone Number</label>
                            <input type="tel" id="whatsapp-phone" class="form-input" placeholder="+1234567890">
                            <p class="text-sm text-gray-500 mt-1">Include country code (e.g., +1 for US)</p>
                        </div>
                        <button id="send-whatsapp-btn" class="w-full btn btn-success">
                            <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            Send via WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Distributions -->
    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-medium text-gray-900">Recent Distributions</h3>
        </div>
        <div class="card-body">
            <div class="text-center py-8 text-gray-500">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                <p class="text-lg font-medium">No distributions yet</p>
                <p class="text-sm">Send your first invitation to see it here</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const templateItems = document.querySelectorAll('.template-item');
    const noTemplateSelected = document.getElementById('no-template-selected');
    const distributionForm = document.getElementById('distribution-form');
    const selectedTemplateInfo = document.getElementById('selected-template-info');
    const selectedTemplateTitle = document.getElementById('selected-template-title');
    const selectedTemplateDetails = document.getElementById('selected-template-details');
    
    const gmailTab = document.getElementById('gmail-tab');
    const whatsappTab = document.getElementById('whatsapp-tab');
    const gmailForm = document.getElementById('gmail-form');
    const whatsappForm = document.getElementById('whatsapp-form');
    
    const sendGmailBtn = document.getElementById('send-gmail-btn');
    const sendWhatsappBtn = document.getElementById('send-whatsapp-btn');
    const previewGmailBtn = document.getElementById('preview-gmail-btn');

    let selectedTemplateId = null;

    // Template selection
    templateItems.forEach(item => {
        item.addEventListener('click', function() {
            // Remove previous selection
            templateItems.forEach(t => t.classList.remove('bg-blue-50', 'border-blue-200'));
            
            // Add selection to current item
            this.classList.add('bg-blue-50', 'border-blue-200');
            
            // Get template data
            selectedTemplateId = this.dataset.templateId;
            const title = this.querySelector('h4').textContent;
            const details = this.querySelector('p').textContent;
            
            // Update UI
            selectedTemplateTitle.textContent = title;
            selectedTemplateDetails.textContent = details;
            
            noTemplateSelected.classList.add('hidden');
            distributionForm.classList.remove('hidden');
            
            // Set default subject for Gmail
            document.getElementById('gmail-subject').value = `Meeting Invitation: ${title}`;
        });
    });

    // Tab switching
    gmailTab.addEventListener('click', function() {
        gmailTab.classList.add('border-blue-500', 'text-blue-600');
        gmailTab.classList.remove('border-transparent', 'text-gray-500');
        whatsappTab.classList.remove('border-blue-500', 'text-blue-600');
        whatsappTab.classList.add('border-transparent', 'text-gray-500');
        gmailForm.classList.remove('hidden');
        whatsappForm.classList.add('hidden');
    });

    whatsappTab.addEventListener('click', function() {
        whatsappTab.classList.add('border-blue-500', 'text-blue-600');
        whatsappTab.classList.remove('border-transparent', 'text-gray-500');
        gmailTab.classList.remove('border-blue-500', 'text-blue-600');
        gmailTab.classList.add('border-transparent', 'text-gray-500');
        whatsappForm.classList.remove('hidden');
        gmailForm.classList.add('hidden');
    });

    // Send Gmail
    sendGmailBtn.addEventListener('click', async function() {
        if (!selectedTemplateId) {
            showToast('Please select a template first', 'error');
            return;
        }

        const recipientsText = document.getElementById('gmail-recipients').value;
        const subject = document.getElementById('gmail-subject').value;

        if (!recipientsText.trim()) {
            showToast('Please enter recipient email(s)', 'error');
            return;
        }

        // Parse multiple emails
        const recipientEmails = recipientsText.split('\n')
            .map(email => email.trim())
            .filter(email => email.length > 0);

        if (recipientEmails.length === 0) {
            showToast('Please enter at least one valid email', 'error');
            return;
        }

        sendGmailBtn.disabled = true;
        sendGmailBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Sending ${recipientEmails.length} invitation(s)...
        `;

        try {
            const response = await apiCall('/api/distribution/gmail', {
                method: 'POST',
                body: JSON.stringify({
                    recipientEmails: recipientEmails,
                    templateId: selectedTemplateId,
                    subject: subject
                })
            });

            if (response.success) {
                showToast(response.message, 'success');
                document.getElementById('gmail-recipients').value = '';
            } else {
                showToast(response.message || 'Failed to send invitations', 'error');
            }
        } catch (error) {
            showToast('Failed to send Gmail: ' + error.message, 'error');
        } finally {
            sendGmailBtn.disabled = false;
            sendGmailBtn.innerHTML = `
                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                Send via Gmail
            `;
        }
    });

    // Preview Gmail
    previewGmailBtn.addEventListener('click', async function() {
        if (!selectedTemplateId) {
            showToast('Please select a template first', 'error');
            return;
        }

        try {
            const response = await apiCall(`/api/templates/${selectedTemplateId}/download`);
            if (response.success) {
                // Open template in new window for preview
                const newWindow = window.open('', '_blank');
                newWindow.document.write(response.html);
                newWindow.document.close();
            }
        } catch (error) {
            showToast('Failed to preview template: ' + error.message, 'error');
        }
    });

    // Send WhatsApp
    sendWhatsappBtn.addEventListener('click', async function() {
        if (!selectedTemplateId) {
            showToast('Please select a template first', 'error');
            return;
        }

        const phoneNumber = document.getElementById('whatsapp-phone').value;

        if (!phoneNumber) {
            showToast('Please enter phone number', 'error');
            return;
        }

        sendWhatsappBtn.disabled = true;
        sendWhatsappBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Sending...
        `;

        try {
            const response = await apiCall('/api/distribution/whatsapp', {
                method: 'POST',
                body: JSON.stringify({
                    phoneNumber: phoneNumber,
                    templateId: selectedTemplateId
                })
            });

            if (response.success) {
                showToast('WhatsApp invitation sent successfully!', 'success');
                document.getElementById('whatsapp-phone').value = '';
            }
        } catch (error) {
            showToast('Failed to send WhatsApp: ' + error.message, 'error');
        } finally {
            sendWhatsappBtn.disabled = false;
            sendWhatsappBtn.innerHTML = `
                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                Send via WhatsApp
            `;
        }
    });

    // Check for template_id in URL (from template generator)
    const urlParams = new URLSearchParams(window.location.search);
    const templateId = urlParams.get('template_id');
    if (templateId) {
        const templateItem = document.querySelector(`[data-template-id="${templateId}"]`);
        if (templateItem) {
            templateItem.click();
        }
    }
});
</script>
{% endblock %} 